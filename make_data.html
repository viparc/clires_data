<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Generating the data from the CliRes database</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<div class="container-fluid main-container">

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->





<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ViParc's data from CliRes</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li>
  <a href="make_data.html">Making data</a>
</li>
<li>
  <a href="test_data.html">Testing data</a>
</li>
<li>
  <a href="explore_data.html">Exploring data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Generating the data from the CliRes database</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#clires-excel-files">CliRes excel files</a></li>
<li><a href="#packages">Packages</a></li>
<li><a href="#utilitary-functions">Utilitary functions</a></li>
<li><a href="#esvacs-iu-to-mg-conversion-data">ESVAC’s IU-to-mg conversion data</a></li>
<li><a href="#drug-codes-from-general-information-data">Drug codes from general information data</a></li>
<li><a href="#the-surveillance-data">The surveillance data</a><ul>
<li><a href="#sampling-dates">Sampling dates</a></li>
<li><a href="#clinical-signs">Clinical signs</a></li>
<li><a href="#antimicrobial-usage">Antimicrobial usage</a></li>
<li><a href="#chicken-data">Chicken data</a></li>
</ul></li>
<li><a href="#merging-into-one-single-data-frame">Merging into one single data frame</a></li>
</ul>
</div>

<div id="clires-excel-files" class="section level2">
<h2>CliRes excel files</h2>
<p>The CliRes data are in 2 excel files, each with many tabs. One of these files contains general information and the other one contains the surveillance data:</p>
<pre class="r"><code>&gt; general_data &lt;- &quot;https://www.dropbox.com/s/gt6k1m781537vd2/16-4-2019-_18ZN_Category_V1_Data.xls?dl=0&quot;
&gt; surveillance_data &lt;- &quot;https://www.dropbox.com/s/7gjt77eltpm4ygw/16-4-2019-_18ZN_V1_Data.xls?dl=0&quot;</code></pre>
</div>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>Installing the required packages:</p>
<pre class="r"><code>&gt; required &lt;- c(&quot;dplyr&quot;, &quot;magrittr&quot;, &quot;purrr&quot;, &quot;readxl&quot;, &quot;tibble&quot;, &quot;tidyr&quot;)
&gt; to_install &lt;- setdiff(required, row.names(installed.packages()))
&gt; if (length(to_install)) install.packages(to_install)</code></pre>
<p>Loading <code>magrittr</code>:</p>
<pre class="r"><code>&gt; library(magrittr)</code></pre>
</div>
<div id="utilitary-functions" class="section level2">
<h2>Utilitary functions</h2>
<p>Naming output of <code>lapply()</code>:</p>
<pre class="r"><code>&gt; lapply2 &lt;- function(X, FUN, ...) setNames(lapply(X, FUN, ...), X)</code></pre>
<p>Tuning the <code>download.file()</code> function in order to be able to download from a Dropbox link:</p>
<pre class="r"><code>&gt; download_dropbox &lt;- function(url, ...) download.file(sub(&quot;dl=0&quot;, &quot;raw=1&quot;, url), ...)</code></pre>
<p>The following function returns the flocks with missing weeks:</p>
<pre class="r"><code>&gt; missing_weeks &lt;- function(x) {
+   a &lt;- x %&gt;%
+     dplyr::group_by(USUBJID, FLOCKSEQUENCE) %&gt;%
+     dplyr::arrange(WEEK) %&gt;%
+     dplyr::summarise(a = length(unique(diff(WEEK)))) %&gt;%
+     dplyr::ungroup() %&gt;%
+     dplyr::filter(a &gt; 1)
+   if (nrow(a)) return(purrr::map2(a$USUBJID,
+                                   a$FLOCKSEQUENCE,
+                                   function(farm, flock)
+                                     x %&gt;%
+                                       dplyr::filter(USUBJID == farm, FLOCKSEQUENCE == flock) %&gt;% 
+                                       dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
+                                     ))
+   message(&quot;There is no missing week.&quot;)
+   invisible(0)
+ }</code></pre>
</div>
<div id="esvacs-iu-to-mg-conversion-data" class="section level2">
<h2>ESVAC’s IU-to-mg conversion data</h2>
<p>The <a href="https://www.ema.europa.eu/en/veterinary-regulatory/overview/antimicrobial-resistance/european-surveillance-veterinary-antimicrobial-consumption-esvac">ESVAC</a> conversion factors are available from the table 2 of page 62 of this <a href="http://www.oie.int">OIE</a> <a href="http://www.oie.int/fileadmin/Home/fr/Our_scientific_expertise/docs/pdf/AMR/Survey_on_monitoring_antimicrobial_agents_Dec2016.pdf">report</a>. A copy-paste of this table without headers is available <a href="https://raw.githubusercontent.com/viparc/clires_data/master/raw_data/esvac.txt">here</a>. Let’s download this file:</p>
<pre class="r"><code>&gt; tmp &lt;- tempfile()
&gt; download.file(&quot;https://raw.githubusercontent.com/viparc/clires_data/master/raw_data/esvac.txt&quot;, tmp)</code></pre>
<p>And read and reformat the data into a named list:</p>
<pre class="r"><code>&gt; esvac &lt;- tmp %&gt;% 
+   readLines() %&gt;% 
+   sub(&quot;^#.*&quot;, &quot;&quot;, .) %&gt;% 
+   sub(&quot; *&quot;, &quot;&quot;, .) %&gt;% 
+   {.[. != &quot;&quot;]} %&gt;% 
+   matrix(ncol = 4, byrow = TRUE) %&gt;% 
+   as.data.frame(stringsAsFactors = FALSE) %&gt;% 
+   setNames(c(&quot;ab_vet_med&quot;, &quot;ab_oie&quot;, &quot;IU.mg&quot;, &quot;mg.IU&quot;)) %&gt;% 
+   dplyr::filter(!grepl(&quot;methane&quot;, ab_vet_med)) %&gt;% 
+   dplyr::transmute(ab_oie = sub(&quot; .*$&quot;, &quot;&quot;, tolower(ab_oie)),
+                    mg.IU  = as.numeric(mg.IU)) %&gt;% 
+   dplyr::bind_rows(data.frame(ab_oie = &quot;josamycin&quot;,
+                               mg.IU  = 0.001, stringsAsFactors = FALSE)) %$%
+   setNames(mg.IU, ab_oie)</code></pre>
<p>Note that we got rid off one of the colistin data and that we manually added the data for josamycin that was absent from the table.</p>
</div>
<div id="drug-codes-from-general-information-data" class="section level2">
<h2>Drug codes from general information data</h2>
<p>Downloading the general data file:</p>
<pre class="r"><code>&gt; tmp &lt;- tempfile()
&gt; download_dropbox(general_data, tmp)</code></pre>
<p>Reformating and merging with the <code>esvac</code> dataframe that we generated above:</p>
<pre class="r"><code>&gt; drug_codes &lt;- c(&quot;ANTIMICROBIAL&quot;, &quot;ANTIMICROBIAL_GridAnti&quot;) %&gt;% 
+   lapply(readxl::read_excel, path = tmp) %&gt;% 
+   purrr::invoke(dplyr::right_join, ., &quot;ANTIMICROBIAL_SEQ&quot;) %&gt;% 
+   dplyr::select(CODE, ANTINAME1, CONCENTRATION, GRIDUNIT, GRIDPACK, GRIDPACKUNIT) %&gt;%
+   dplyr::filter(! ANTINAME1 %in% c(&quot;alicin&quot;, &quot;axit oxolinic&quot;, &quot;iodo-hydroxyquinoline&quot;, &quot;metronidazol&quot;, &quot;nystatin&quot;)) %&gt;% 
+   dplyr::mutate(ANTINAME1     = dplyr::recode(ANTINAME1, sunfadimethoxine  = &quot;sulfadimethoxine&quot;,
+                                                          sunphamethoxazole = &quot;sulphamethoxazole&quot;),
+                 GRIDUNIT      = dplyr::na_if(GRIDUNIT, &quot;NA&quot;),
+                 GRIDUNIT      = dplyr::na_if(GRIDUNIT, &quot;na&quot;),
+                 GRIDUNIT      = dplyr::recode(GRIDUNIT, UI = &quot;IU&quot;, mg = &quot;MG&quot;),
+                 GRIDPACKUNIT  = dplyr::na_if(GRIDPACKUNIT, &quot;na&quot;),
+                 GRIDPACKUNIT  = dplyr::na_if(GRIDPACKUNIT, &quot;VI&quot;),
+                 GRIDPACKUNIT  = dplyr::recode(GRIDPACKUNIT, g  = &quot;G&quot;, ml = &quot;G&quot;, ML = &quot;G&quot;),
+                 GRIDPACK      = dplyr::na_if(GRIDPACK, &quot;na&quot;),
+                 GRIDPACK      = as.numeric(GRIDPACK),
+                 CONCENTRATION = dplyr::na_if(CONCENTRATION, &quot;NA&quot;),
+                 CONCENTRATION = dplyr::na_if(CONCENTRATION, &quot;na&quot;),
+                 CONCENTRATION = dplyr::recode(CONCENTRATION, S = &quot;500&quot;), # this will ultimately be corrected in CliRes
+                 CONCENTRATION = as.numeric(CONCENTRATION),
+                 CONCENTRATION = ifelse(GRIDUNIT == &quot;IU&quot;, CONCENTRATION * esvac[ANTINAME1], CONCENTRATION),
+                 GRIDUNIT      = ifelse(GRIDUNIT == &quot;IU&quot;, &quot;MG&quot;, GRIDUNIT), # linked to the above line
+                 CONCENTRATION = ifelse(GRIDUNIT == &quot;MG&quot;, CONCENTRATION / 1000, CONCENTRATION),
+                 GRIDUNIT      = ifelse(GRIDUNIT == &quot;MG&quot;, &quot;G&quot;, GRIDUNIT), # linked to the above line
+                 GRIDPACK      = ifelse(GRIDPACKUNIT == &quot;KG&quot;, 1000 * GRIDPACK, GRIDPACK),
+                 GRIDPACKUNIT  = ifelse(GRIDPACKUNIT == &quot;KG&quot;, &quot;G&quot;, GRIDPACKUNIT), # linked to the above line
+                 proportion    = CONCENTRATION / GRIDPACK)</code></pre>
</div>
<div id="the-surveillance-data" class="section level2">
<h2>The surveillance data</h2>
<p>Downloading the surveillance data file:</p>
<pre class="r"><code>&gt; tmp &lt;- tempfile()
&gt; download_dropbox(surveillance_data, tmp)</code></pre>
<p>For antimicrobial, disease and chicken data in the surveillance file, we need the following pairs of tabs respectively, that we have to merge:</p>
<pre class="r"><code>&gt; antimicrobial &lt;- c(&quot;ANTIMICROBIAL&quot;, &quot;ANTIMICROBIAL_GridEvent&quot;)
&gt; disease &lt;- c(&quot;DISEASE&quot;, &quot;DISEASE_GridEvent&quot;)
&gt; chicks &lt;- c(&quot;MID_INOUT&quot;, &quot;MID_INOUT_GridEvent&quot;)</code></pre>
<p>Reading the data from file:</p>
<pre class="r"><code>&gt; surveillance &lt;- lapply2(c(antimicrobial, disease, chicks, &quot;SAMPLE&quot;),
+                         readxl::read_excel, path = tmp)</code></pre>
<div id="sampling-dates" class="section level3">
<h3>Sampling dates</h3>
<p>Retrieving the sampling dates:</p>
<pre class="r"><code>&gt; samplesdata &lt;- surveillance$SAMPLE %&gt;% 
+   dplyr::select(USUBJID, FLOCKSEQUENCE, SAMPLINGDATE, SAMPLINGVISIT) %&gt;% 
+   unique()</code></pre>
<p>Here we have to break the pipeline because we need to use the <code>samplesdata</code> at two distincts points in the section that follows:</p>
<pre class="r"><code>&gt; samples &lt;- samplesdata %&gt;%
+   dplyr::filter(SAMPLINGVISIT == &quot;S&quot;) %&gt;%
+   dplyr::select(-SAMPLINGVISIT) %&gt;%
+   dplyr::rename(start = SAMPLINGDATE) %&gt;%
+   dplyr::right_join(samplesdata, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;)) %&gt;%
+   dplyr::mutate(WEEK     = as.numeric(floor((SAMPLINGDATE - start) / (60 * 60 * 24 * 7)) + 1),
+                 sampling = TRUE) %&gt;% 
+   dplyr::select(-start, -SAMPLINGDATE, -SAMPLINGVISIT)</code></pre>
<p>This data frame contains all the dates of sampling, one per row.</p>
</div>
<div id="clinical-signs" class="section level3">
<h3>Clinical signs</h3>
<p>Retrieving the clinical signs data:</p>
<pre class="r"><code>&gt; clinical_signs0 &lt;- surveillance[disease] %&gt;% 
+   unname() %&gt;% 
+   purrr::invoke(dplyr::left_join, ., c(&quot;USUBJID&quot;, &quot;DISEASE_SEQ&quot;)) %&gt;%
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK, RESPIRATORY, DIARRHOEA, CNS, MALAISE, LEGLESIONS, SUDDENDEATH)</code></pre>
<p>There are two corrections that cannot be done in CliRes and that we have to do here. We also have to break the pipeline because we uses the <code>clinical_signs0</code> dataframe that we just created at two distinct points in the section that follows:</p>
<pre class="r"><code>&gt; clinical_signs &lt;- clinical_signs0 %&gt;% 
+ # correction 1: 2 weeks 8 and no week 9 for cycle 2 of farm 8. These 2 weeks are identical
+   dplyr::filter(USUBJID == &quot;75-008&quot;, FLOCKSEQUENCE == &quot;02&quot;, WEEK == 8) %&gt;% 
+   dplyr::mutate(WEEK = 8:9) %&gt;%
+   dplyr::bind_rows(dplyr::filter(clinical_signs0, !(USUBJID == &quot;75-008&quot; &amp; FLOCKSEQUENCE == &quot;02&quot; &amp; WEEK == 8))) %&gt;% 
+ # correction 2: week 19 instead of 10 for cycle 6 of farm 21:
+   dplyr::mutate(WEEK = ifelse(USUBJID == &quot;75-021&quot; &amp; FLOCKSEQUENCE == &quot;06&quot; &amp; WEEK == 19, 10, WEEK))</code></pre>
<p>This data frame contains all the weeks of all the flocks of all the farms. There is no missing weeks:</p>
<pre class="r"><code>&gt; missing_weeks(clinical_signs)
There is no missing week.</code></pre>
</div>
<div id="antimicrobial-usage" class="section level3">
<h3>Antimicrobial usage</h3>
<p>Here we’ll merge with the <code>drug_codes</code> dataframe that we generated above.</p>
<pre class="r"><code>&gt; amu &lt;- surveillance[antimicrobial] %&gt;% 
+   unname() %&gt;% 
+   purrr::invoke(dplyr::left_join, ., c(&quot;USUBJID&quot;, &quot;ANTIMICROBIAL_SEQ&quot;)) %&gt;% 
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEKNO, CODE, AMOUTUSED, PACKAGEUNIT) %&gt;%
+   dplyr::rename(WEEK = WEEKNO) %&gt;% 
+   dplyr::mutate(PACKAGEUNIT = dplyr::na_if(PACKAGEUNIT, &quot;TAB&quot;)) %&gt;% 
+   dplyr::left_join(drug_codes, &quot;CODE&quot;) %&gt;%
+   tidyr::replace_na(list(ANTINAME1 = &quot;unknown&quot;)) %&gt;% # because some antibiotic names are unknown
+   dplyr::mutate(presence    = 1,
+                 antibiotic  = proportion * AMOUTUSED,
+                 antibiotic2 = antibiotic,
+                 antiname2   = paste0(ANTINAME1, &quot;_g&quot;),
+                 antiname3   = paste0(ANTINAME1, &quot;_g.kg&quot;),
+                 ANTINAME1   = paste0(ANTINAME1, &quot;_use&quot;)) %&gt;%
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK, ANTINAME1, presence, antiname2, antibiotic, antiname3, antibiotic2) %&gt;% 
+   tibble::rowid_to_column() %&gt;% # spread() requires unique row identifiers
+   tidyr::spread(ANTINAME1, presence) %&gt;%
+   tidyr::spread(antiname2, antibiotic) %&gt;%
+   tidyr::spread(antiname3, antibiotic2) %&gt;%
+   dplyr::select(-rowid) %&gt;% # we don&#39;t need rowid anymore
+   replace(is.na(.), 0) %&gt;%
+   dplyr::group_by(USUBJID, FLOCKSEQUENCE, WEEK) %&gt;%
+   dplyr::summarise_all(~sum(.)) %&gt;%
+   dplyr::mutate_at(dplyr::vars(dplyr::ends_with(&quot;_use&quot;, FALSE)), function(x) x &gt; 0) %&gt;% 
+   dplyr::mutate_at(dplyr::vars(dplyr::ends_with(&quot;_use&quot;)), . %&gt;% ifelse(is.na(.), FALSE, .)) %&gt;% 
+   dplyr::mutate_at(dplyr::vars(dplyr::ends_with(&quot;_g&quot;)), . %&gt;% ifelse(is.na(.), 0, .)) %&gt;% 
+   dplyr::mutate_at(dplyr::vars(dplyr::ends_with(&quot;_g.kg&quot;)), . %&gt;% ifelse(is.na(.), 0, .))</code></pre>
<p>This data frame is supposed to contain one row per week per flock per farm. It happens that week 16 of flock 3 of farm 81 is missing:</p>
<pre class="r"><code>&gt; missing_weeks(amu)
[[1]]
# A tibble: 17 x 3
# Groups:   USUBJID, FLOCKSEQUENCE [1]
   USUBJID FLOCKSEQUENCE  WEEK
   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;
 1 75-081  03                1
 2 75-081  03                2
 3 75-081  03                3
 4 75-081  03                4
 5 75-081  03                5
 6 75-081  03                6
 7 75-081  03                7
 8 75-081  03                8
 9 75-081  03                9
10 75-081  03               10
11 75-081  03               11
12 75-081  03               12
13 75-081  03               13
14 75-081  03               14
15 75-081  03               15
16 75-081  03               17
17 75-081  03               18</code></pre>
<p>but that won’t be a problem when it’s merged with <code>clinical_signs</code> below.</p>
</div>
<div id="chicken-data" class="section level3">
<h3>Chicken data</h3>
<p>Retrieving data on chicken demographics:</p>
<pre class="r"><code>&gt; chickendata &lt;- surveillance[chicks] %&gt;% 
+   unname() %&gt;% 
+   purrr::invoke(dplyr::left_join, ., c(&quot;USUBJID&quot;, &quot;MID_INOUT_SEQ&quot;)) %&gt;% 
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK, CHICKENTOTAL) %&gt;% 
+   unique() %&gt;% 
+   dplyr::mutate_at(&quot;CHICKENTOTAL&quot;, as.integer)</code></pre>
<p>Here we have to break the pipeline because <code>chickendata</code> is used at two distinct points in the part below:</p>
<pre class="r"><code>&gt; chicken &lt;- chickendata %&gt;%
+   dplyr::group_by(USUBJID, FLOCKSEQUENCE) %&gt;%
+   dplyr::summarize(completed = min(CHICKENTOTAL) &lt; 1) %&gt;%
+   dplyr::ungroup() %&gt;% 
+   dplyr::right_join(chickendata, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;))</code></pre>
<p>This data frame is supposed to contain one row per week per flock per farm. It happens that week 6 of flock 8 of farm 70 is missing:</p>
<pre class="r"><code>&gt; missing_weeks(chicken)
[[1]]
# A tibble: 17 x 3
   USUBJID FLOCKSEQUENCE  WEEK
   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;
 1 75-070  08                1
 2 75-070  08                2
 3 75-070  08                3
 4 75-070  08                4
 5 75-070  08                5
 6 75-070  08                7
 7 75-070  08                8
 8 75-070  08                9
 9 75-070  08               10
10 75-070  08               11
11 75-070  08               12
12 75-070  08               13
13 75-070  08               14
14 75-070  08               15
15 75-070  08               16
16 75-070  08               17
17 75-070  08               18</code></pre>
</div>
</div>
<div id="merging-into-one-single-data-frame" class="section level2">
<h2>Merging into one single data frame</h2>
<p>Checking that there is no week defined in <code>amu</code> but not in <code>clinical_signs</code>:</p>
<pre class="r"><code>&gt; dplyr::anti_join(amu, clinical_signs, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% 
+   nrow() %&gt;% 
+   `&lt;`(1)
[1] FALSE</code></pre>
<p>Checking that there is no week defined in <code>chicken</code> but not in <code>clinical_signs</code>:</p>
<pre class="r"><code>&gt; dplyr::anti_join(chicken, clinical_signs, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% 
+   nrow() %&gt;% 
+   `&lt;`(1)
[1] TRUE</code></pre>
<p>We are ready for the merging and writing to disk:</p>
<pre class="r"><code>&gt; if (!dir.exists(&quot;data&quot;)) dir.create(&quot;data&quot;)
&gt; list(clinical_signs, amu, chicken, samples) %&gt;%
+   purrr::reduce(dplyr::left_join, by = c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;%
+   dplyr::mutate(sampling = ! is.na(sampling)) %&gt;% 
+   dplyr::mutate_at(dplyr::vars(FLOCKSEQUENCE, WEEK), as.integer) %&gt;% 
+   dplyr::arrange(USUBJID, FLOCKSEQUENCE, WEEK) %&gt;% 
+   write.csv(&quot;data/viparc.csv&quot;, FALSE, row.names = FALSE)</code></pre>
<p>Note that, among the <code>clinical_signs</code>, <code>amu</code>, <code>chicken</code> and <code>samples</code> data frames, <code>samples</code> is the only one that contains rows only for the weeks where samples are taken. The three other data frames contain rows for all the weeks of all the flocks of all the farms. For this reason, after the merging, we have to replace the missing values in the <code>sampling</code> variable by <code>FALSE</code>.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
