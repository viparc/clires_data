<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Generating the data from the CliRes database</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ViParc's data from CliRes</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li>
  <a href="make_data.html">Making data</a>
</li>
<li>
  <a href="test_data.html">Testing data</a>
</li>
<li>
  <a href="explore_data.html">Exploring data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Generating the data from the CliRes database</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#clires-excel-files">CliRes excel files</a></li>
<li><a href="#packages">Packages</a></li>
<li><a href="#utilitary-functions">Utilitary functions</a></li>
<li><a href="#esvacs-iu-to-mg-conversion-data">ESVAC’s IU-to-mg conversion data</a></li>
<li><a href="#drug-codes-from-general-information-data">Drug codes from general information data</a></li>
<li><a href="#the-surveillance-data">The surveillance data</a><ul>
<li><a href="#sampling-dates">Sampling dates</a></li>
<li><a href="#clinical-signs">Clinical signs</a></li>
<li><a href="#antimicrobial-usage">Antimicrobial usage</a></li>
<li><a href="#chicken-data">Chicken data</a></li>
</ul></li>
<li><a href="#merging-into-one-single-data-frame">Merging into one single data frame</a></li>
</ul>
</div>

<div id="clires-excel-files" class="section level2">
<h2>CliRes excel files</h2>
<p>The CliRes data are in 2 excel files, each with many tabs. One of these files contains general information and the other one contains the surveillance data:</p>
<pre class="r"><code>&gt; general_data &lt;- &quot;https://www.dropbox.com/s/3hfnhd39fxjmcnh/20-5-2019-_18ZN_Category_V1_Data.xls?dl=0&quot;
&gt; surveillance_data &lt;- &quot;https://www.dropbox.com/s/4kk6qewmntw3q5o/20-5-2019-_18ZN_V1_Data.xls?dl=0&quot;</code></pre>
</div>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>Installing the required packages:</p>
<pre class="r"><code>&gt; required &lt;- c(&quot;dplyr&quot;, &quot;magrittr&quot;, &quot;purrr&quot;, &quot;readxl&quot;, &quot;tibble&quot;, &quot;tidyr&quot;)
&gt; to_install &lt;- setdiff(required, row.names(installed.packages()))
&gt; if (length(to_install)) install.packages(to_install)</code></pre>
<p>Loading <code>magrittr</code>:</p>
<pre class="r"><code>&gt; library(magrittr)</code></pre>
</div>
<div id="utilitary-functions" class="section level2">
<h2>Utilitary functions</h2>
<p>Naming output of <code>lapply()</code>:</p>
<pre class="r"><code>&gt; lapply2 &lt;- function(X, FUN, ...) setNames(lapply(X, FUN, ...), X)</code></pre>
<p>Tuning the <code>download.file()</code> function in order to be able to download from a Dropbox link:</p>
<pre class="r"><code>&gt; download_dropbox &lt;- function(url, ...) download.file(sub(&quot;dl=0&quot;, &quot;raw=1&quot;, url), ...)</code></pre>
<p>The following function returns the flocks with missing weeks:</p>
<pre class="r"><code>&gt; missing_weeks &lt;- function(x) {
+   tmp &lt;- x %&gt;%
+     dplyr::group_by(USUBJID, FLOCKSEQUENCE) %&gt;%
+     dplyr::arrange(WEEK) %&gt;%
+     dplyr::summarise(a = length(unique(diff(WEEK)))) %&gt;%
+     dplyr::ungroup() %&gt;%
+     dplyr::filter(a &gt; 1)
+   if (nrow(tmp)) return(purrr::map2(tmp$USUBJID,
+                                     tmp$FLOCKSEQUENCE,
+                                     function(farm, flock)
+                                       x %&gt;%
+                                         dplyr::filter(USUBJID == farm, FLOCKSEQUENCE == flock) %&gt;% 
+                                         dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)))
+   message(&quot;There is no missing week.&quot;)
+   invisible(0)
+ }</code></pre>
</div>
<div id="esvacs-iu-to-mg-conversion-data" class="section level2">
<h2>ESVAC’s IU-to-mg conversion data</h2>
<p>The <a href="https://www.ema.europa.eu/en/veterinary-regulatory/overview/antimicrobial-resistance/european-surveillance-veterinary-antimicrobial-consumption-esvac">ESVAC</a> conversion factors are available from the table 2 of page 62 of this <a href="http://www.oie.int">OIE</a> <a href="http://www.oie.int/fileadmin/Home/fr/Our_scientific_expertise/docs/pdf/AMR/Survey_on_monitoring_antimicrobial_agents_Dec2016.pdf">report</a>. A copy-paste of this table without headers is available <a href="https://raw.githubusercontent.com/viparc/clires_data/master/raw_data/esvac.txt">here</a>. Let’s download this file:</p>
<pre class="r"><code>&gt; tmp &lt;- tempfile()
&gt; download.file(&quot;https://raw.githubusercontent.com/viparc/clires_data/master/raw_data/esvac.txt&quot;, tmp)</code></pre>
<p>And read and reformat the data into a named numeric vector:</p>
<pre class="r"><code>&gt; (esvac &lt;- tmp %&gt;% 
+   readLines() %&gt;% 
+   sub(&quot;^#.*&quot;, &quot;&quot;, .) %&gt;% 
+   sub(&quot; *&quot;, &quot;&quot;, .) %&gt;% 
+   {.[. != &quot;&quot;]} %&gt;% 
+   matrix(ncol = 4, byrow = TRUE) %&gt;% 
+   as.data.frame(stringsAsFactors = FALSE) %&gt;% 
+   setNames(c(&quot;ab_vet_med&quot;, &quot;ab_oie&quot;, &quot;IU.mg&quot;, &quot;mg.IU&quot;)) %&gt;% 
+   dplyr::filter(!grepl(&quot;methane&quot;, ab_vet_med)) %&gt;% 
+   dplyr::transmute(ab_oie = sub(&quot; .*$&quot;, &quot;&quot;, tolower(ab_oie)),
+                    mg.IU  = as.numeric(mg.IU)) %&gt;% 
+   dplyr::bind_rows(data.frame(ab_oie = &quot;josamycin&quot;,
+                               mg.IU  = 0.001, stringsAsFactors = FALSE)) %$%
+   setNames(mg.IU, ab_oie))
         bacitracin    benzylpenicillin   chlortetracycline            colistin dihydrostreptomycin        erythromycin          gentamicin           kanamycin            neomycin            neomycin     oxytetracycline         paromomycin 
           0.013514            0.000600            0.001111            0.000049            0.001220            0.001087            0.001613            0.001256            0.001325            0.001492            0.001149            0.001481 
          polymyxin           rifamycin          spiramycin        streptomycin          tobramycin             tylosin        tetracycline           josamycin 
           0.000119            0.001127            0.000313            0.001274            0.001143            0.001000            0.001000            0.001000 </code></pre>
<p>Note that we got rid off one of the colistin data and that we manually added the data for josamycin that was absent from the table.</p>
</div>
<div id="drug-codes-from-general-information-data" class="section level2">
<h2>Drug codes from general information data</h2>
<p>Downloading the general data file:</p>
<pre class="r"><code>&gt; tmp &lt;- tempfile()
&gt; download_dropbox(general_data, tmp)</code></pre>
<p>Reformating and merging with the <code>esvac</code> dataframe that we generated above:</p>
<pre class="r"><code>&gt; (drug_codes &lt;- c(&quot;ANTIMICROBIAL&quot;, &quot;ANTIMICROBIAL_GridAnti&quot;) %&gt;% 
+   lapply(readxl::read_excel, path = tmp) %&gt;% 
+   c(list(c(&quot;ANTIMICROBIAL_SEQ&quot;))) %&gt;% 
+   do.call(dplyr::right_join, .) %&gt;%
+   dplyr::select(CODE, ANTINAME1, CONCENTRATION, GRIDUNIT, GRIDPACK, GRIDPACKUNIT) %&gt;%
+   dplyr::filter(! ANTINAME1 %in% c(&quot;alicin&quot;, &quot;axit oxolinic&quot;, &quot;iodo-hydroxyquinoline&quot;, &quot;metronidazol&quot;, &quot;nystatin&quot;)) %&gt;% 
+   dplyr::mutate(ANTINAME1     = dplyr::recode(ANTINAME1, sunfadimethoxine  = &quot;sulfadimethoxine&quot;,
+                                                          sunphamethoxazole = &quot;sulphamethoxazole&quot;),
+                 GRIDUNIT      = dplyr::na_if(GRIDUNIT, &quot;NA&quot;),
+                 GRIDUNIT      = dplyr::na_if(GRIDUNIT, &quot;na&quot;),
+                 GRIDUNIT      = dplyr::recode(GRIDUNIT, UI = &quot;IU&quot;, mg = &quot;MG&quot;),
+                 GRIDPACKUNIT  = dplyr::na_if(GRIDPACKUNIT, &quot;na&quot;),
+                 GRIDPACKUNIT  = dplyr::na_if(GRIDPACKUNIT, &quot;VI&quot;),
+                 GRIDPACKUNIT  = dplyr::recode(GRIDPACKUNIT, g  = &quot;G&quot;, ml = &quot;G&quot;, ML = &quot;G&quot;),
+                 GRIDPACK      = dplyr::na_if(GRIDPACK, &quot;na&quot;),
+                 GRIDPACK      = as.numeric(GRIDPACK),
+                 CONCENTRATION = dplyr::na_if(CONCENTRATION, &quot;NA&quot;),
+                 CONCENTRATION = dplyr::na_if(CONCENTRATION, &quot;na&quot;),
+                 CONCENTRATION = dplyr::recode(CONCENTRATION, S = &quot;500&quot;), # this will ultimately be corrected in CliRes CORRECTION
+                 CONCENTRATION = as.numeric(CONCENTRATION),
+                 CONCENTRATION = ifelse(GRIDUNIT == &quot;IU&quot;, CONCENTRATION * esvac[ANTINAME1], CONCENTRATION),
+                 GRIDUNIT      = ifelse(GRIDUNIT == &quot;IU&quot;, &quot;MG&quot;, GRIDUNIT), # linked to the above line
+                 CONCENTRATION = ifelse(GRIDUNIT == &quot;MG&quot;, CONCENTRATION / 1000, CONCENTRATION),
+                 GRIDUNIT      = ifelse(GRIDUNIT == &quot;MG&quot;, &quot;G&quot;, GRIDUNIT), # linked to the above line
+                 GRIDPACK      = ifelse(GRIDPACKUNIT == &quot;KG&quot;, 1000 * GRIDPACK, GRIDPACK),
+                 GRIDPACKUNIT  = ifelse(GRIDPACKUNIT == &quot;KG&quot;, &quot;G&quot;, GRIDPACKUNIT), # linked to the above line
+                 proportion    = CONCENTRATION / GRIDPACK) %&gt;% 
+   dplyr::select(CODE, ANTINAME1, proportion))
# A tibble: 461 x 3
   CODE  ANTINAME1       proportion
   &lt;chr&gt; &lt;chr&gt;                &lt;dbl&gt;
 1 AB001 colistin          0.000735
 2 AB001 oxytetracycline   0.015   
 3 AB002 oxytetracycline   0.07    
 4 AB002 colistin          0.0098  
 5 AB003 neomycin          0.0795  
 6 AB003 colistin          0.0147  
 7 AB004 oxytetracycline   0.01    
 8 AB005 gentamicin        0.06    
 9 AB005 colistin          0.0245  
10 AB006 doxycycline       0.2     
# … with 451 more rows</code></pre>
</div>
<div id="the-surveillance-data" class="section level2">
<h2>The surveillance data</h2>
<p>Downloading the surveillance data file:</p>
<pre class="r"><code>&gt; tmp &lt;- tempfile()
&gt; download_dropbox(surveillance_data, tmp)</code></pre>
<p>For antimicrobial, disease and chicken data in the surveillance file, we need the following pairs of tabs respectively, that we have to merge:</p>
<pre class="r"><code>&gt; antimicrobial &lt;- c(&quot;ANTIMICROBIAL&quot;, &quot;ANTIMICROBIAL_GridEvent&quot;)
&gt; disease &lt;- c(&quot;DISEASE&quot;, &quot;DISEASE_GridEvent&quot;)
&gt; chicks &lt;- c(&quot;MID_INOUT&quot;, &quot;MID_INOUT_GridEvent&quot;)</code></pre>
<p>Reading the data from file:</p>
<pre class="r"><code>&gt; (surveillance &lt;- lapply2(c(antimicrobial, disease, chicks, &quot;SAMPLE&quot;),
+                          readxl::read_excel, path = tmp))
$ANTIMICROBIAL
# A tibble: 5,567 x 11
   EVENT USUBJID ANTIMICROBIAL_SEQ STUDYID SITEID FARMCODE FLOCKSEQUENCE WEEKNO ANTIBIOTICNO entry enteredtime        
   &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dttm&gt;             
 1 FLOCK 75-001                  1 18ZN    75     001      01                 1            1     2 2017-01-31 11:17:24
 2 FLOCK 75-002                  1 18ZN    75     002      01                 1            1     2 2017-02-24 15:46:27
 3 FLOCK 75-003                  1 18ZN    75     003      01                 1            0     2 2017-02-01 12:21:30
 4 FLOCK 75-004                  1 18ZN    75     004      01                 1            1     2 2017-01-31 15:53:38
 5 FLOCK 75-005                  1 18ZN    75     005      01                 1            2     2 2017-01-09 09:21:55
 6 FLOCK 75-006                  1 18ZN    75     006      01                 1            1     2 2017-02-01 14:04:31
 7 FLOCK 75-007                  1 18ZN    75     007      01                 1            1     2 2017-01-26 20:14:44
 8 FLOCK 75-008                  1 18ZN    75     008      01                 1            1     2 2017-01-31 16:56:22
 9 FLOCK 75-009                  1 18ZN    75     009      01                 1            1     2 2017-01-04 15:47:35
10 FLOCK 75-010                  1 18ZN    75     010      01                 1            2     2 2017-01-09 10:56:58
# … with 5,557 more rows

$ANTIMICROBIAL_GridEvent
# A tibble: 1,808 x 15
   ANTIMICROBIAL_SEQ EVENT USUBJID ANTIMICROBIAL_GridEvent_SEQ CODE  INITIAL   AMOUTUSED PACKAGE PACKAGEUNIT  COST ALLFLOCK CHCKENUSEDNO PREVENTION entry enteredtime        
               &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;                         &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;lgl&gt;           &lt;dbl&gt; &lt;lgl&gt;      &lt;dbl&gt; &lt;dttm&gt;             
 1                 1 FLOCK 75-001                            1 AB001 COLITERRA       100 100     G           17000 TRUE               NA TRUE           2 2017-01-31 11:17:24
 2                 1 FLOCK 75-002                            1 AB001 COLITERRA        50 100     G           17000 TRUE               NA TRUE           2 2017-02-24 15:46:27
 3                 1 FLOCK 75-004                            1 AB001 COLITERRA       100 100     G           17000 TRUE               NA TRUE           2 2017-01-31 15:53:38
 4                 1 FLOCK 75-005                            1 AB001 Coliterra       100 100     G           25000 TRUE               NA TRUE           2 2017-01-09 09:21:55
 5                 1 FLOCK 75-006                            1 AB001 COLITERRA       100 100     G           25000 TRUE               NA TRUE           2 2017-02-01 14:04:31
 6                 1 FLOCK 75-007                            1 AB001 Coliterra       100 100     G           32000 TRUE               NA TRUE           2 2017-01-26 20:14:44
 7                 1 FLOCK 75-008                            1 AB001 COLITERRA       600 100     G           25000 TRUE               NA TRUE           2 2017-01-31 16:56:22
 8                 1 FLOCK 75-009                            1 AB001 Coliterra        50 100     G           35000 TRUE               NA TRUE           2 2017-01-04 15:47:35
 9                 1 FLOCK 75-010                            1 AB001 Coliterra       100 100     G           25000 TRUE               NA TRUE           2 2017-01-09 10:56:58
10                 1 FLOCK 75-011                            1 AB001 Coliterra       100 100     G           15000 TRUE               NA TRUE           2 2017-01-09 09:59:28
# … with 1,798 more rows

$DISEASE
# A tibble: 322 x 9
   EVENT USUBJID DISEASE_SEQ STUDYID SITEID FARMCODE FLOCKSEQUENCE entry enteredtime        
   &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;         &lt;dbl&gt; &lt;dttm&gt;             
 1 FLOCK 75-001            1 18ZN    75     001      01                2 2017-01-31 11:16:13
 2 FLOCK 75-002            1 18ZN    75     002      01                2 2017-02-24 15:45:23
 3 FLOCK 75-003            1 18ZN    75     003      01                2 2017-02-01 12:18:11
 4 FLOCK 75-004            1 18ZN    75     004      01                2 2017-01-31 15:52:40
 5 FLOCK 75-005            1 18ZN    75     005      01                2 2017-01-09 09:20:57
 6 FLOCK 75-006            1 18ZN    75     006      01                2 2017-02-01 14:03:44
 7 FLOCK 75-007            1 18ZN    75     007      01                2 2017-01-26 20:13:38
 8 FLOCK 75-008            1 18ZN    75     008      01                2 2017-01-31 16:55:40
 9 FLOCK 75-009            1 18ZN    75     009      01                2 2017-01-04 15:46:23
10 FLOCK 75-010            1 18ZN    75     010      01                2 2017-01-09 10:54:05
# … with 312 more rows

$DISEASE_GridEvent
# A tibble: 5,565 x 17
   DISEASE_SEQ EVENT USUBJID DISEASE_GridEvent_SEQ  WEEK RESPIRATORY DIARRHOEA CNS   MALAISE LEGLESIONS SUDDENDEATH OTHDISEASE                       CHICKENSICKNO CHICKENDISEASEDEATH CHICKENSUDDENDEATH entry enteredtime        
         &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;                   &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;       &lt;lgl&gt;     &lt;lgl&gt; &lt;lgl&gt;   &lt;lgl&gt;      &lt;lgl&gt;       &lt;chr&gt;                                    &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;dttm&gt;             
 1           1 FLOCK 75-001                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      TRUE        &lt;NA&gt;                                        NA                  NA                  3     2 2017-01-31 11:16:13
 2           1 FLOCK 75-002                      1     1 FALSE       FALSE     FALSE TRUE    FALSE      FALSE       &lt;NA&gt;                                         5                   5                 NA     2 2017-02-24 15:45:23
 3           1 FLOCK 75-003                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      FALSE       CHUOT CAN                                   NA                  19                 NA     2 2017-02-01 12:18:12
 4           1 FLOCK 75-004                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      FALSE       YEU CHET                                    NA                   2                 NA     2 2017-01-31 15:52:40
 5           1 FLOCK 75-005                      1     1 FALSE       TRUE      FALSE TRUE    FALSE      FALSE       &lt;NA&gt;                                        28                   8                 NA     2 2017-01-09 09:20:58
 6           1 FLOCK 75-006                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      FALSE       1 CON BI DE CHET                             2                   3                 NA     2 2017-02-01 14:03:45
 7           1 FLOCK 75-007                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      FALSE       Ga khuyet tat                               NA                   4                 NA     2 2017-01-26 20:13:38
 8           1 FLOCK 75-008                      1     1 FALSE       FALSE     FALSE TRUE    FALSE      FALSE       06 CON CHET KHONG RO NGUYEN NHAN             4                   4                  6     2 2017-01-31 16:55:40
 9           1 FLOCK 75-009                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      FALSE       &lt;NA&gt;                                        NA                  NA                 NA     2 2017-01-04 15:46:23
10           1 FLOCK 75-010                      1     1 FALSE       FALSE     FALSE FALSE   FALSE      FALSE       &lt;NA&gt;                                        NA                  NA                 NA     2 2017-01-09 10:54:05
# … with 5,555 more rows

$MID_INOUT
# A tibble: 322 x 9
   EVENT USUBJID MID_INOUT_SEQ STUDYID SITEID FARMCODE FLOCKSEQUENCE entry enteredtime        
   &lt;chr&gt; &lt;chr&gt;           &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;         &lt;dbl&gt; &lt;dttm&gt;             
 1 FLOCK 75-001              1 18ZN    75     001      01                2 2017-01-31 11:00:56
 2 FLOCK 75-002              1 18ZN    75     002      01                2 2017-02-01 14:25:02
 3 FLOCK 75-003              1 18ZN    75     003      01                2 2017-02-01 12:04:35
 4 FLOCK 75-004              1 18ZN    75     004      01                2 2017-01-31 15:36:13
 5 FLOCK 75-005              1 18ZN    75     005      01                2 2017-01-09 09:05:19
 6 FLOCK 75-006              1 18ZN    75     006      01                2 2017-02-01 13:52:37
 7 FLOCK 75-007              1 18ZN    75     007      01                2 2017-01-26 20:00:20
 8 FLOCK 75-008              1 18ZN    75     008      01                2 2017-01-31 16:41:08
 9 FLOCK 75-009              1 18ZN    75     009      01                2 2017-01-04 15:29:06
10 FLOCK 75-010              1 18ZN    75     010      01                2 2017-01-09 10:36:04
# … with 312 more rows

$MID_INOUT_GridEvent
# A tibble: 5,566 x 19
   MID_INOUT_SEQ EVENT USUBJID MID_INOUT_GridEv…  WEEK CHICKENBOUGHT BUYINGCOST OTHCHICKEN OTHCHICKENSPEC ADDINGCHICKENTOT… CHICKENSELLINGT… SELLINGTOTALKGS CHICKENSELLINGV… OTHCHICKENEX EXREASON  CHICKENEXTOTAL CHICKENTOTAL entry enteredtime        
           &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;                      &lt;dbl&gt;            &lt;dbl&gt; &lt;lgl&gt;                      &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dttm&gt;             
 1             1 FLOCK 75-001                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA            3 CHET DOT…              3          207     2 2017-01-31 11:00:56
 2             1 FLOCK 75-002                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA            5 CHET BENH              5          500     2 2017-02-01 14:25:02
 3             1 FLOCK 75-003                  1     1            NA         NA         NA &lt;NA&gt;                           0               NA NA                            NA           25 CHUOT CAN             25          381     2 2018-10-29 09:49:51
 4             1 FLOCK 75-004                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA            2 YEU CHET               2          713     2 2017-01-31 15:36:13
 5             1 FLOCK 75-005                  1     1             8      96000         NA &lt;NA&gt;                           8               NA NA                            NA            8 chết bệnh              8          102     2 2018-10-25 09:33:31
 6             1 FLOCK 75-006                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA            5 3 CO CHE…              5           97     2 2018-10-25 09:41:55
 7             1 FLOCK 75-007                  1     1            NA         NA         NA &lt;NA&gt;                           0               NA NA                            NA            4 yeu, khu…              4           98     2 2017-01-26 20:00:20
 8             1 FLOCK 75-008                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA           10 06 CON C…             10          590     2 2017-01-31 16:41:08
 9             1 FLOCK 75-009                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA           NA &lt;NA&gt;                  NA          153     2 2018-08-26 09:54:30
10             1 FLOCK 75-010                  1     1            NA         NA         NA &lt;NA&gt;                          NA               NA NA                            NA           NA 0                     NA          410     2 2018-08-26 09:55:01
# … with 5,556 more rows

$SAMPLE
# A tibble: 961 x 19
   EVENT  USUBJID SAMPLE_SEQ STUDYID SITEID FARMCODE FLOCKSEQUENCE SAMPLINGDATE        SAMPLINGVISIT BOOTSWAB CLOACALSWAB LIVECHICKEN ESAMPLE ESAMPLESPEC FLOCKPIC FLOCKPIC1 DEVICEINDEX1 entry enteredtime        
   &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;         &lt;dttm&gt;              &lt;chr&gt;         &lt;lgl&gt;    &lt;lgl&gt;       &lt;lgl&gt;       &lt;lgl&gt;   &lt;lgl&gt;       &lt;lgl&gt;    &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt; &lt;dttm&gt;             
 1 Sample 75-001           1 18ZN    75     001      01            2016-10-24 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     001-S-01  101-0013         2 2016-10-27 15:38:03
 2 Sample 75-002           1 18ZN    75     002      01            2016-10-24 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     002-S-01  101-0018         2 2016-12-02 08:22:22
 3 Sample 75-003           1 18ZN    75     003      01            2016-10-28 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     003-S-01  101-0024         2 2016-11-07 16:18:17
 4 Sample 75-004           1 18ZN    75     004      01            2016-10-28 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     004-S-01  101-0029         2 2016-11-07 16:19:04
 5 Sample 75-005           1 18ZN    75     005      01            2016-11-09 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     005-S-01  103-0267         2 2016-12-02 08:39:51
 6 Sample 75-006           1 18ZN    75     006      01            2016-11-09 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     006-S-01  103-0289         2 2016-12-02 08:47:52
 7 Sample 75-007           1 18ZN    75     007      01            2016-11-09 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     007-S-01  103-0302         2 2016-12-02 08:59:47
 8 Sample 75-008           1 18ZN    75     008      01            2016-11-09 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     008-S-01  103-0326         2 2016-12-02 09:15:08
 9 Sample 75-009           1 18ZN    75     009      01            2016-11-09 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     009-S-01  102-0037         2 2016-12-02 09:21:22
10 Sample 75-010           1 18ZN    75     010      01            2016-11-16 00:00:00 S             TRUE     FALSE       FALSE       FALSE   NA          TRUE     010-S-01  102-0042         2 2016-12-02 09:27:39
# … with 951 more rows</code></pre>
<div id="sampling-dates" class="section level3">
<h3>Sampling dates</h3>
<p>Retrieving the sampling dates. One key feature of the code below is to convert a sampling date into a week index. <code>SAMPLINGVISIT</code> tells whether the visit is at the start (<code>S</code>), the middle (<code>M</code>) or the end (<code>E</code>) of the flock.</p>
<pre class="r"><code>&gt; (samples &lt;- surveillance$SAMPLE %&gt;%
+ # End sampling of flock 2 of farm 75-013 is duplicated, so we filter it out: CORRECTION
+   dplyr::filter(!(USUBJID == &quot;75-013&quot; &amp; FLOCKSEQUENCE == &quot;02&quot; &amp; SAMPLE_SEQ == 8)) %&gt;% 
+   dplyr::select(USUBJID, FLOCKSEQUENCE, SAMPLINGDATE, SAMPLINGVISIT) %&gt;%
+   assign(&quot;tmp&quot;, ., 1) %&gt;% # for reuse 4 lines later
+   dplyr::filter(SAMPLINGVISIT == &quot;S&quot;) %&gt;% # | gets the date...
+   dplyr::select(-SAMPLINGVISIT) %&gt;%       # | ... of the first week...
+   dplyr::rename(start = SAMPLINGDATE) %&gt;% # | ... of each flock.
+   dplyr::right_join(tmp, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;)) %&gt;%
+   dplyr::mutate(WEEK     = as.numeric(floor((SAMPLINGDATE - start) / (60 * 60 * 24 * 7)) + 1),
+                 sampling = TRUE) %&gt;% 
+   dplyr::select(-start, -SAMPLINGDATE, -SAMPLINGVISIT) %&gt;% 
+   unique()) # dates of first visits are missing for flock 2 of farm 75-019, THIS NEED TO BE FIXED!!!!!
# A tibble: 957 x 4
   USUBJID FLOCKSEQUENCE  WEEK sampling
   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt; &lt;lgl&gt;   
 1 75-001  01                1 TRUE    
 2 75-002  01                1 TRUE    
 3 75-003  01                1 TRUE    
 4 75-004  01                1 TRUE    
 5 75-005  01                1 TRUE    
 6 75-006  01                1 TRUE    
 7 75-007  01                1 TRUE    
 8 75-008  01                1 TRUE    
 9 75-009  01                1 TRUE    
10 75-010  01                1 TRUE    
# … with 947 more rows
&gt;             # flock 3 of farm 75-029 and flock 2 of farm 75-058. CORRECTION</code></pre>
<p>This data frame contains all the dates of sampling, one per row.</p>
</div>
<div id="clinical-signs" class="section level3">
<h3>Clinical signs</h3>
<p>Retrieving the clinical signs data. Note that there are 2 corrections that we need to do here.</p>
<pre class="r"><code>&gt; (clinical_signs &lt;- surveillance[disease] %&gt;% 
+   unname() %&gt;% # because of the do.call() call that follows
+   c(list(c(&quot;USUBJID&quot;, &quot;DISEASE_SEQ&quot;))) %&gt;% 
+   do.call(dplyr::left_join, .) %&gt;%
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK, RESPIRATORY, DIARRHOEA, CNS, MALAISE,
+                 LEGLESIONS, SUDDENDEATH, DISEASE_GridEvent_SEQ, CHICKENDISEASEDEATH, CHICKENSUDDENDEATH) %&gt;% 
+   dplyr::mutate(CHICKENDISEASEDEATH = tidyr::replace_na(CHICKENDISEASEDEATH, 0),
+                 CHICKENSUDDENDEATH = tidyr::replace_na(CHICKENSUDDENDEATH, 0)) %&gt;% 
+   assign(&quot;tmp&quot;, ., 1) %&gt;% # for reuse 3 lines later
+ # CORRECTION 1: weeks 8 instead of 9 for one of the two records of cycle 2 of farm 8:
+   dplyr::filter(USUBJID == &quot;75-008&quot;, FLOCKSEQUENCE == &quot;02&quot;, DISEASE_GridEvent_SEQ == 9) %&gt;% 
+   dplyr::mutate(WEEK = 9) %&gt;%
+   dplyr::bind_rows(dplyr::filter(tmp, !(USUBJID == &quot;75-008&quot; &amp; FLOCKSEQUENCE == &quot;02&quot; &amp; DISEASE_GridEvent_SEQ == 9))) %&gt;% 
+   assign(&quot;tmp&quot;, ., 1) %&gt;% # for reuse 3 lines later
+ # CORRECTION 2: week 19 instead of 10 for cycle 6 of farm 21:
+   dplyr::filter(USUBJID == &quot;75-021&quot;, FLOCKSEQUENCE == &quot;06&quot;, DISEASE_GridEvent_SEQ == 10) %&gt;% 
+   dplyr::mutate(WEEK = 10) %&gt;%
+   dplyr::bind_rows(dplyr::filter(tmp, !(USUBJID == &quot;75-021&quot; &amp; FLOCKSEQUENCE == &quot;06&quot; &amp; DISEASE_GridEvent_SEQ == 10))) %&gt;% 
+   dplyr::select(-DISEASE_GridEvent_SEQ))
# A tibble: 5,565 x 11
   USUBJID FLOCKSEQUENCE  WEEK RESPIRATORY DIARRHOEA CNS   MALAISE LEGLESIONS SUDDENDEATH CHICKENDISEASEDEATH CHICKENSUDDENDEATH
   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt; &lt;lgl&gt;       &lt;lgl&gt;     &lt;lgl&gt; &lt;lgl&gt;   &lt;lgl&gt;      &lt;lgl&gt;                     &lt;dbl&gt;              &lt;dbl&gt;
 1 75-021  06               10 FALSE       FALSE     FALSE FALSE   FALSE      FALSE                         0                  0
 2 75-008  02                9 FALSE       FALSE     FALSE FALSE   FALSE      FALSE                         0                  0
 3 75-001  01                1 FALSE       FALSE     FALSE FALSE   FALSE      TRUE                          0                  3
 4 75-001  01                2 FALSE       FALSE     FALSE FALSE   FALSE      FALSE                         0                  0
 5 75-001  01                3 FALSE       FALSE     FALSE FALSE   FALSE      TRUE                          0                  1
 6 75-001  01                4 FALSE       FALSE     FALSE FALSE   FALSE      FALSE                         0                  0
 7 75-001  01                5 FALSE       FALSE     FALSE FALSE   FALSE      FALSE                         0                  0
 8 75-001  01                6 FALSE       FALSE     FALSE FALSE   FALSE      TRUE                          0                  2
 9 75-001  01                7 FALSE       FALSE     FALSE FALSE   FALSE      FALSE                         0                  0
10 75-001  01                8 FALSE       FALSE     FALSE FALSE   FALSE      TRUE                          0                  2
# … with 5,555 more rows</code></pre>
<p>This data frame contains all the weeks of all the flocks of all the farms. There is no missing weeks:</p>
<pre class="r"><code>&gt; missing_weeks(clinical_signs)
There is no missing week.</code></pre>
</div>
<div id="antimicrobial-usage" class="section level3">
<h3>Antimicrobial usage</h3>
<p>Here we’ll merge with the <code>drug_codes</code> dataframe that we generated above.</p>
<pre class="r"><code>&gt; (amu &lt;- surveillance[antimicrobial] %&gt;% 
+   unname() %&gt;% # because of the do.call() call that follows
+   c(list(c(&quot;USUBJID&quot;, &quot;ANTIMICROBIAL_SEQ&quot;))) %&gt;% 
+   do.call(dplyr::left_join, .) %&gt;%
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEKNO, CODE, AMOUTUSED, PACKAGEUNIT) %&gt;%
+   dplyr::rename(WEEK = WEEKNO) %&gt;% 
+   dplyr::mutate(PACKAGEUNIT = dplyr::na_if(PACKAGEUNIT, &quot;TAB&quot;)) %&gt;% 
+   dplyr::left_join(drug_codes, &quot;CODE&quot;) %&gt;%
+   tidyr::replace_na(list(ANTINAME1 = &quot;unknown&quot;)) %&gt;% # because some antibiotic names are unknown
+   dplyr::mutate(antibiotic  = proportion * AMOUTUSED,
+                 ANTINAME1   = paste0(ANTINAME1, &quot;_g&quot;)) %&gt;%
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK, ANTINAME1, antibiotic) %&gt;% 
+   tibble::rowid_to_column() %&gt;% # spread() requires unique row identifiers
+   tidyr::spread(ANTINAME1, antibiotic) %&gt;%
+   dplyr::select(-rowid) %&gt;% # we don&#39;t need rowid anymore
+   replace(is.na(.), 0) %&gt;%
+   dplyr::group_by(USUBJID, FLOCKSEQUENCE, WEEK) %&gt;%
+   dplyr::summarise_all(~sum(.)) %&gt;%
+   dplyr::ungroup() %&gt;% 
+   dplyr::mutate_at(dplyr::vars(dplyr::ends_with(&quot;_g&quot;)), . %&gt;% ifelse(is.na(.), 0, .)))
# A tibble: 5,566 x 48
   USUBJID FLOCKSEQUENCE  WEEK amoxicillin_g ampicillin_g apramycin_g cefadroxil_g cefotaxime_g ceftiofur_g cephalexin_g chloramphenicol… ciprofloxacin_g colistin_g doxycycline_g enramycin_g enrofloxacin_g erythromycin_g florfenicol_g flumequine_g
   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
 1 75-001  01                1             0            0           0            0            0           0            0                0               0     0.0735             0           0              0              0             0            0
 2 75-001  01                2             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 3 75-001  01                3             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 4 75-001  01                4             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 5 75-001  01                5             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 6 75-001  01                6             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 7 75-001  01                7             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 8 75-001  01                8             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
 9 75-001  01                9             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
10 75-001  01               10             0            0           0            0            0           0            0                0               0     0                  0           0              0              0             0            0
# … with 5,556 more rows, and 29 more variables: gentamicin_g &lt;dbl&gt;, josamycin_g &lt;dbl&gt;, kitasamycin_g &lt;dbl&gt;, lincomycin_g &lt;dbl&gt;, marbofloxacin_g &lt;dbl&gt;, methenamine_g &lt;dbl&gt;, neomycin_g &lt;dbl&gt;, norfloxacin_g &lt;dbl&gt;, oxytetracycline_g &lt;dbl&gt;,
#   spectinomycin_g &lt;dbl&gt;, spiramycin_g &lt;dbl&gt;, streptomycin_g &lt;dbl&gt;, sulfachloropyridazine_g &lt;dbl&gt;, sulfadiazine_g &lt;dbl&gt;, sulfadimethoxine_g &lt;dbl&gt;, sulfadimidine_g &lt;dbl&gt;, sulfaguanidin_g &lt;dbl&gt;, sulfamethazine_g &lt;dbl&gt;, sulfamethoxazole_g &lt;dbl&gt;,
#   sulfamethoxypyridazine_g &lt;dbl&gt;, sulphamethoxazole_g &lt;dbl&gt;, sulphathiazole_g &lt;dbl&gt;, tetracycline_g &lt;dbl&gt;, thiamphenicol_g &lt;dbl&gt;, tiamulin_g &lt;dbl&gt;, tilmicosin_g &lt;dbl&gt;, trimethoprim_g &lt;dbl&gt;, tylosin_g &lt;dbl&gt;, unknown_g &lt;dbl&gt;</code></pre>
<p>No missing weeks:</p>
<pre class="r"><code>&gt; missing_weeks(amu)
There is no missing week.</code></pre>
</div>
<div id="chicken-data" class="section level3">
<h3>Chicken data</h3>
<p>Below is the code to retrieve data on chicken demographics. In there, we are computing a variable indicating whether the cycle is finisheed.</p>
<pre class="r"><code>&gt; (chicken &lt;- surveillance[chicks] %&gt;% 
+   unname() %&gt;% # because of the do.call() call that follows
+   c(list(c(&quot;USUBJID&quot;, &quot;MID_INOUT_SEQ&quot;))) %&gt;% 
+   do.call(dplyr::left_join, .) %&gt;%
+   dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK, CHICKENTOTAL, MID_INOUT_GridEvent_SEQ) %&gt;% 
+ # CORRECTION:
+   assign(&quot;tmp&quot;, ., 1) %&gt;% # for reuse 3 lines below
+   dplyr::filter(USUBJID == &quot;75-070&quot;, FLOCKSEQUENCE == &quot;08&quot;, MID_INOUT_GridEvent_SEQ == 6) %&gt;% 
+   dplyr::mutate(WEEK = 6) %&gt;% 
+   dplyr::bind_rows(dplyr::filter(tmp, !(USUBJID == &quot;75-070&quot; &amp; FLOCKSEQUENCE == &quot;08&quot; &amp; MID_INOUT_GridEvent_SEQ == 6))) %&gt;% 
+   dplyr::select(-MID_INOUT_GridEvent_SEQ) %&gt;% 
+ # (end of correction)
+   dplyr::mutate_at(&quot;CHICKENTOTAL&quot;, as.integer) %&gt;% 
+   assign(&quot;tmp&quot;, ., 1) %&gt;% # for reuse on the final line
+   dplyr::group_by(USUBJID, FLOCKSEQUENCE) %&gt;%             # | computing whether...
+   dplyr::summarize(completed = min(CHICKENTOTAL) &lt; 1) %&gt;% # | ... the cycle is...
+   dplyr::ungroup() %&gt;%                                    # | ... finished.
+   dplyr::right_join(tmp, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;)))
# A tibble: 5,566 x 5
   USUBJID FLOCKSEQUENCE completed  WEEK CHICKENTOTAL
   &lt;chr&gt;   &lt;chr&gt;         &lt;lgl&gt;     &lt;dbl&gt;        &lt;int&gt;
 1 75-070  08            TRUE          6          498
 2 75-001  01            TRUE          1          207
 3 75-001  01            TRUE          2          207
 4 75-001  01            TRUE          3          206
 5 75-001  01            TRUE          4          206
 6 75-001  01            TRUE          5          206
 7 75-001  01            TRUE          6          204
 8 75-001  01            TRUE          7          204
 9 75-001  01            TRUE          8          202
10 75-001  01            TRUE          9          202
# … with 5,556 more rows</code></pre>
<p>No missing week:</p>
<pre class="r"><code>&gt; missing_weeks(chicken)
There is no missing week.</code></pre>
</div>
</div>
<div id="merging-into-one-single-data-frame" class="section level2">
<h2>Merging into one single data frame</h2>
<p>Here, we merge the 4 data frames that were computed above: <code>samples</code>, <code>clinical_signs</code>, <code>amu</code> and <code>chicken</code>. First, we need to check that there is no incompatibility between the <code>amu</code>, <code>clinical_signs</code> and <code>chicken</code> data frames:</p>
<pre class="r"><code>&gt; dplyr::anti_join(amu, clinical_signs, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
# A tibble: 1 x 3
  USUBJID FLOCKSEQUENCE  WEEK
  &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;
1 75-004  05               17
&gt; dplyr::anti_join(clinical_signs, amu, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
# A tibble: 0 x 3
# … with 3 variables: USUBJID &lt;chr&gt;, FLOCKSEQUENCE &lt;chr&gt;, WEEK &lt;dbl&gt;
&gt; dplyr::anti_join(chicken, clinical_signs, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
# A tibble: 1 x 3
  USUBJID FLOCKSEQUENCE  WEEK
  &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;
1 75-077  06               18
&gt; dplyr::anti_join(clinical_signs, chicken, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
# A tibble: 0 x 3
# … with 3 variables: USUBJID &lt;chr&gt;, FLOCKSEQUENCE &lt;chr&gt;, WEEK &lt;dbl&gt;
&gt; dplyr::anti_join(amu, chicken, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
# A tibble: 1 x 3
  USUBJID FLOCKSEQUENCE  WEEK
  &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;
1 75-004  05               17
&gt; dplyr::anti_join(chicken, amu, c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;% dplyr::select(USUBJID, FLOCKSEQUENCE, WEEK)
# A tibble: 1 x 3
  USUBJID FLOCKSEQUENCE  WEEK
  &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt;
1 75-077  06               18</code></pre>
<p>The week <code>17</code> of flock <code>05</code> of the farm <code>75-004</code> should be removed from the <code>amu</code> data set:</p>
<pre class="r"><code>&gt; amu %&gt;%
+   dplyr::filter(USUBJID == &quot;75-004&quot;, FLOCKSEQUENCE == &quot;05&quot;, WEEK == 17) %&gt;%
+   dplyr::select(-USUBJID, -FLOCKSEQUENCE, -WEEK) %&gt;%
+   unlist() %&gt;%
+   unique()
[1] 0</code></pre>
<p>Let’s remove it:</p>
<pre class="r"><code>&gt; amu %&lt;&gt;% dplyr::filter(!(USUBJID == &quot;75-004&quot; &amp; FLOCKSEQUENCE == &quot;05&quot; &amp; WEEK == 17))</code></pre>
<p>Furthermore, is seems that there is no data for the week <code>18</code> of the flock <code>06</code> of the farm <code>75-077</code> in the <code>amu</code> and <code>clinical_signs</code> data frame.</p>
<pre class="r"><code>&gt; nrow(amu)
[1] 5565
&gt; nrow(chicken)
[1] 5566
&gt; nrow(clinical_signs)
[1] 5565</code></pre>
<p>We are ready for the merging and writing to disk:</p>
<pre class="r"><code>&gt; if (!dir.exists(&quot;data&quot;)) dir.create(&quot;data&quot;)
&gt; list(chicken, clinical_signs, amu, samples) %&gt;% # chicken needs to be first because it&#39;s the only df with no NA
+   purrr::reduce(dplyr::left_join, by = c(&quot;USUBJID&quot;, &quot;FLOCKSEQUENCE&quot;, &quot;WEEK&quot;)) %&gt;%
+   dplyr::mutate(sampling = ! is.na(sampling)) %&gt;% # because in samples there are only sampled weeks
+   dplyr::mutate_at(dplyr::vars(FLOCKSEQUENCE, WEEK), as.integer) %&gt;% 
+   dplyr::arrange(USUBJID, FLOCKSEQUENCE, WEEK)  %&gt;%
+   dplyr::rename(farm                  = USUBJID,
+                 flock                 = FLOCKSEQUENCE,
+                 week                  = WEEK,
+                 respiratory           = RESPIRATORY,
+                 diarrhoea             = DIARRHOEA,
+                 cns                   = CNS,
+                 malaise               = MALAISE,
+                 leg_lesions           = LEGLESIONS,
+                 sudden_death          = SUDDENDEATH,
+                 nb_chicken            = CHICKENTOTAL,
+                 chicken_disease_death = CHICKENDISEASEDEATH,
+                 chicken_sudden_death  = CHICKENSUDDENDEATH) %&gt;% 
+   dplyr::select(farm, flock, week, sampling, completed, nb_chicken, chicken_disease_death, chicken_sudden_death, dplyr::everything()) %&gt;% 
+   write.csv(&quot;data/viparc.csv&quot;, FALSE, row.names = FALSE)</code></pre>
<p>Note that, among the <code>clinical_signs</code>, <code>amu</code>, <code>chicken</code> and <code>samples</code> data frames, <code>samples</code> is the only one that contains rows only for the weeks where samples are taken. The three other data frames contain rows for all the weeks of all the flocks of all the farms. For this reason, after the merging, we have to replace the missing values in the <code>sampling</code> variable by <code>FALSE</code>.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
